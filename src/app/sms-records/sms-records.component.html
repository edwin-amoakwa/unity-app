<h1 class="page-title">SMS Records</h1>

<app-card cardTitle="SMS Records">
  <div class="card-body">
    <!-- Filter Section -->
    <div class="row mb-3">
      <div class="col-md-3">
        <label for="finalStatus" class="form-label">Final Status</label>
        <p-dropdown
          id="finalStatus"
          [options]="smsStatusList"
          [(ngModel)]="filterParam.smsStatus"
          optionLabel="itemName"
          optionValue="id"
          placeholder="Select Final Status"
          [showClear]="true"
          (onChange)="onFilterChange()"
          styleClass="w-100">
        </p-dropdown>
      </div>
      <div class="col-md-3">
        <label for="senderId" class="form-label">Sender ID</label>
        <p-dropdown
          id="senderId"
          [options]="senderIdOptions"
          [(ngModel)]="filterParam.senderId"
          optionLabel="senderId"
          optionValue="senderId"
          placeholder="Select Sender ID"
          [showClear]="true"
          (onChange)="onFilterChange()"
          styleClass="w-100">
        </p-dropdown>
      </div>
      <div class="col-md-3 d-flex align-items-end">
        <p-button
          label="Clear Filters"
          icon="pi pi-filter-slash"
          severity="secondary"
          size="small"
          (onClick)="clearFilters()">
        </p-button>
      </div>
    </div>

    <!-- SMS Records Table -->
    <p-table
      [value]="smsRecords"
      [loading]="isLoading"
      [paginator]="true"
      [rows]="20"
      [responsive]="true"
      styleClass="p-datatable-sm"
      [scrollable]="true"
      scrollHeight="600px"
      dataKey="id">

      <ng-template #header>
        <tr>
          <th ></th>
          <th >Mobile No</th>
          <th >Sender ID</th>
          <th >Application</th>
          <th >Recipient</th>
          <th >SMS Text</th>
          <th >SMS Provider</th>
          <th >SMS Status</th>
          <th > Cost</th>
          <th >Pages</th>
        </tr>
      </ng-template>

      <ng-template #body  let-record let-expanded="expanded">
        <tr>
          <td>
            <p-button
              type="button"
              pRipple
              [pRowToggler]="record"
              [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
              severity="secondary"
              size="small"
              [text]="true">
            </p-button>
          </td>
          <td>{{ record.mobileNo }}</td>
          <td>{{ record.senderId }}</td>
          <td>{{ record.application }}</td>
          <td>{{ record.receipient }}</td>
          <td>
            <div class="text-truncate" style="max-width: 200px;" [pTooltip]="record.smsText">
              {{ truncateText(record.smsText, 50) }}
            </div>
          </td>
          <td>{{ record.smsProviderLabel }}</td>
          <td>
            <p-tag
              [value]="record.smsStatusLabel"
              [severity]="getSmsStatusSeverity(record.smsStatusLabel)">
            </p-tag>
          </td>
          <td>{{ formatCurrency(record.buyPrice) }}</td>
          <td>{{ record.pageCount }}</td>
        </tr>
      </ng-template>

      <ng-template #expandedrow  let-record>
        <tr>
          <td colspan="10">
            <div class="p-3">
              <h5>Additional Details</h5>
              <div class="row">
                <div class="col-md-4">
                  <div class="mb-2">
                    <strong>Internal Status:</strong>
                    <span class="ms-2">{{ record.internalStatus }}</span>
                  </div>
                  <div class="mb-2">
                    <strong>External ID:</strong>
                    <span class="ms-2">{{ record.externalId }}</span>
                  </div>
                  <div class="mb-2">
                    <strong>Provider Status:</strong>
                    <span class="ms-2">{{ record.providerStatus }}</span>
                  </div>
                  <div class="mb-2">
                    <strong>Processing No:</strong>
                    <span class="ms-2">{{ record.processingNo }}</span>
                  </div>
                  <div class="mb-2">
                    <strong>URL Reached:</strong>
                    <p-tag
                      class="ms-2"
                      [value]="record.urlReached ? 'Yes' : 'No'"
                      [severity]="record.urlReached ? 'success' : 'danger'">
                    </p-tag>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="mb-2">
                    <strong>Delivered Time:</strong>
                    <span class="ms-2">{{ formatDateTime(record.deliveredTime) }}</span>
                  </div>
                  <div class="mb-2">
                    <strong>Callback URL:</strong>
                    <span class="ms-2" [pTooltip]="record.callBackUrl">
                      {{ truncateText(record.callBackUrl, 30) }}
                    </span>
                  </div>
                  <div class="mb-2">
                    <strong>Feedback:</strong>
                    <p-tag
                      class="ms-2"
                      [value]="record.feedBackReceived ? 'Yes' : 'No'"
                      [severity]="record.feedBackReceived ? 'success' : 'warning'">
                    </p-tag>
                  </div>
                  <div class="mb-2">
                    <strong>Feedback Count:</strong>
                    <span class="ms-2">{{ record.feedbackRequestCount }}</span>
                  </div>
                  <div class="mb-2">
                    <strong>Batch ID:</strong>
                    <span class="ms-2">{{ record.batchId }}</span>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="mb-2">
                    <strong>Created Date:</strong>
                    <span class="ms-2">{{ formatDateTime(record.createdDate) }}</span>
                  </div>
                  <div class="mb-2">
                    <strong>Modified Date:</strong>
                    <span class="ms-2">{{ formatDateTime(record.modifiedDate) }}</span>
                  </div>
                </div>
              </div>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="10" class="text-center p-4">
            <div class="flex flex-column align-items-center gap-2">
              <i class="pi pi-inbox text-4xl text-muted"></i>
              <p class="text-muted mb-0">No SMS records found</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</app-card>
